{% extends "base.html" %}

{% block title %}Game Session · Match Maker{% endblock %}
{% block body_class %}game-session{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/game-session.css') }}">
{% endblock %}

{% block intro %}
<p class="intro">Game Session</p>
{% endblock %}

{% block content %}
  <!-- Game Info -->
  <div class="game-info">
    <h2>Game #{{ game_no }}</h2>
    <p class="court">(Court A)</p>
  </div>

  <!-- Teams -->
  <div class="teams">
    <div class="team-box team-a">
      <span class="player">{{ team_a[0] }}</span> + <span class="player">{{ team_a[1] }}</span>
    </div>
    <div class="vs-circle">Vs</div>
    <div class="team-box team-b">
      <span class="player">{{ team_b[0] }}</span> + <span class="player">{{ team_b[1] }}</span>
    </div>
  </div>

  <!-- Scoreboard -->
  <div class="scoreboard">
    <!-- Team A -->
    <div class="score-column">
      <div class="score-box team-a-score">
        <div class="score-number" id="scoreA">0</div>
      </div>
      <div class="controls">
        <button type="button" class="btn-control" onclick="changeScore('A', -1)">−</button>
        <button type="button" class="btn-control" onclick="changeScore('A', 1)">+</button>
      </div>
    </div>

    <!-- Team B -->
    <div class="score-column">
      <div class="score-box team-b-score">
        <div class="score-number" id="scoreB">0</div>
      </div>
      <div class="controls">
        <button type="button" class="btn-control" onclick="changeScore('B', 1)">+</button>
        <button type="button" class="btn-control" onclick="changeScore('B', -1)">−</button>
      </div>
    </div>
  </div>


  <!-- Duration -->
  <p class="duration">Game Duration: <span id="duration">0’</span></p>

  <!-- Buttons -->
  <div class="button-row">
    <button type="button" class="btn btn-blue" onclick="endGame()">End This Game</button>
    <button type="button" class="btn btn-orange" onclick="nextMatch()">Next Match</button>
  </div>
{% endblock %}

{% block scripts %}
<script>
  let scoreA = 0, scoreB = 0;
  const limit = {{ point_limit|default(21) }};
  const durationEl = document.getElementById('duration');
  const nextBtn = document.querySelector(".btn-orange");
  const teamABox = document.querySelector(".team-a-score");
  const teamBBox = document.querySelector(".team-b-score");

  let seconds = 0;
  let timer = null;

  // start timer
  function startTimer() {
    timer = setInterval(() => {
      seconds++;
      let mins = Math.floor(seconds / 60);
      let secs = seconds % 60;
      durationEl.textContent = `${mins}’${secs.toString().padStart(2,'0')}`;
    }, 1000);
  }
  startTimer();

  // Initially disable Next Match
  nextBtn.disabled = true;

  function changeScore(team, delta) {
    if (team === 'A') {
      scoreA = Math.max(0, Math.min(limit, scoreA + delta));
      document.getElementById('scoreA').textContent = scoreA;
    } else {
      scoreB = Math.max(0, Math.min(limit, scoreB + delta));
      document.getElementById('scoreB').textContent = scoreB;
    }
  }

  function endGame() {
    clearInterval(timer); // stop duration
    let winnerText = "";

    if (scoreA > scoreB) {
      teamABox.classList.add("winner");
      teamBBox.classList.add("loser");
      winnerText = "Team A: {{ team_a[0] }} + {{ team_a[1] }}";
    } else if (scoreB > scoreA) {
      teamBBox.classList.add("winner");
      teamABox.classList.add("loser");
      winnerText = "Team B: {{ team_b[0] }} + {{ team_b[1] }}";
    } else {
      winnerText = "It's a tie!";
    }

    // Winner message with SVG pencil icon
    const winnerMsg = document.createElement("p");
    winnerMsg.classList.add("winner-msg");
    winnerMsg.innerHTML = `The Winner is ${winnerText} 
      <span class="edit-icon">
        <img src="{{ url_for('static', filename='images/pencil.svg') }}" alt="Edit">
      </span>`;
    durationEl.parentElement.appendChild(winnerMsg);

    // Pencil click → revert
    winnerMsg.querySelector(".edit-icon").addEventListener("click", () => {
      teamABox.classList.remove("winner", "loser");
      teamBBox.classList.remove("winner", "loser");
      winnerMsg.remove();
      nextBtn.disabled = true;
      startTimer(); // resume
    });

    // Enable Next Match
    nextBtn.disabled = false;
  }

  function nextMatch() {
    window.location.href = "{{ url_for('drawing') }}";
  }
</script>
{% endblock %}


